<project name="LOUICe" basedir="." default="package">
    <!-- setup a prefix for all environment variables -->
    <property environment="env" />

    <!-- Setup paths for build -->
    <property name="main.src.loc" location="${basedir}/src/" />
    <property name="test.src.loc" location="${basedir}/src/flexUnitTests" />
    <property name="lib.loc" location="${basedir}/libs" />
    <property name="output.loc" location="${basedir}/target" />
    <property name="bin.loc" location="${output.loc}/bin" />
    <property name="report.loc" location="${output.loc}/report" />
    <property name="dist.loc" location="${output.loc}/dist" />

    <!-- Setup Flex and FlexUnit ant tasks -->
    <property name="FLEX_HOME" location="${env.FLEX_HOME}" />
    <taskdef resource="flexTasks.tasks" classpath="${FLEX_HOME}/ant/lib/flexTasks.jar" />
    <taskdef resource="flexUnitTasks.tasks" classpath="${FLEX_HOME}/ant/lib/flexUnitTasks-4.1.0.jar" />

    <target name="clean">
        <!-- Remove all directories created during the build process -->
        <delete dir="${output.loc}" />
    </target>

    <target name="init">
        <!-- Create directories needed for the build process -->
        <mkdir dir="${output.loc}" />
        <mkdir dir="${bin.loc}" />
        <mkdir dir="${report.loc}" />
        <mkdir dir="${dist.loc}" />
    </target>

    <target name="compile" depends="init">
        <!-- Compile Main.mxml as a SWF -->
        <mxmlc file="${main.src.loc}/LOUICe.mxml" output="${bin.loc}/LOUICe.swf">
            <library-path dir="${lib.loc}" append="true">
                <include name="*.swc" />
            </library-path>
            <compiler.verbose-stacktraces>true</compiler.verbose-stacktraces>
            <compiler.headless-server>true</compiler.headless-server>
        </mxmlc>
    </target>

    <target name="test" depends="compile">
        <!-- Compile TestRunner.mxml as a SWF -->
        <mxmlc file="${test.src.loc}/TestRunner.mxml" output="${bin.loc}/TestRunner.swf">
            <source-path path-element="${main.src.loc}" />
            <library-path dir="${lib.loc}" append="true">
                <include name="*.swc" />
            </library-path>
            <compiler.verbose-stacktraces>true</compiler.verbose-stacktraces>
            <compiler.headless-server>true</compiler.headless-server>
        </mxmlc>

        <!-- Execute TestRunner.swf as FlexUnit tests and publish reports -->
        <flexunit swf="${bin.loc}/TestRunner.swf"
            toDir="${report.loc}"
            haltonfailure="false"
            verbose="true"
            localTrusted="true" />

        <!-- Generate readable JUnit-style reports -->
        <junitreport todir="${report.loc}">
            <fileset dir="${report.loc}">
                <include name="TEST-*.xml" />
            </fileset>
            <report format="frames" todir="${report.loc}/html" />
        </junitreport>
    </target>

    <target name="package" depends="test">
        <!-- Assemble final website -->
        <copy file="${bin.loc}/Main.swf" todir="${dist.loc}" />
        <html-wrapper swf="Main" output="${dist.loc}" height="100%" width="100%" />

        <!-- Zip up final website -->
        <zip destfile="${output.loc}/${ant.project.name}.zip">
            <fileset dir="${dist.loc}" />
        </zip>
    </target>
</project>